<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediCart - Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./Footer/footer.css">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8fafc; }
    #address-modal { display: none; }
    #address-modal.show { display: flex !important; }
    
    /* Custom scrollbar for items container */
    #order-items-container {
      max-height: 420px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #F875AA #f8fafc;
    }
    
    #order-items-container::-webkit-scrollbar {
      width: 6px;
    }
    
    #order-items-container::-webkit-scrollbar-track {
      background: #f8fafc;
      border-radius: 10px;
    }
    
    #order-items-container::-webkit-scrollbar-thumb {
      background: #F875AA;
      border-radius: 10px;
    }
    
    #order-items-container::-webkit-scrollbar-thumb:hover {
      background: #F875AA;
    }
    
    /* Hide scrollbar when less than 3 items */
    #order-items-container.no-scroll {
      overflow-y: hidden;
      max-height: none;
    }
    
    /* Smooth transitions */
    .transition-all { transition: all 0.3s ease; }
    
    /* Quantity selector styles */
    .quantity-selector {
      display: flex;
      align-items: center;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      width: fit-content;
    }
    
    .qty-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 600;
    }
    
    .qty-btn:hover {
      background: #f3f4f6;
    }
    
    .qty-btn.decrease {
      border-right: 1px solid #e5e7eb;
    }
    
    .qty-btn.increase {
      border-left: 1px solid #e5e7eb;
    }
    
    .qty-value {
      width: 40px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      border: none;
      background: rgb(255, 255, 255);
      padding: 6px 0;
    }
    
    .qty-value:focus {
      outline: none;
      background: #fef3f7;
    }
    
    /* Delete button styles */
    .delete-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: 1px solid #fecaca;
      color: #ef4444;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .delete-btn:hover {
      background: #fef2f2;
      transform: scale(1.05);
    }
    
    /* Item quantity indicator */
    .item-quantity-indicator {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #F875AA;
      color: white;
      font-size: 11px;
      font-weight: 600;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Payment option styles */
    .payment-option {
      transition: all 0.3s ease;
    }
    
    .payment-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .payment-option.selected {
      border-color: #70B2B2;
      background-color: #f0f9f9;
    }
  </style>
</head>
<body class="bg-gray-50">

  <div id="header-placeholder"></div>

  <main class="container mx-auto px-4 py-6 max-w-6xl">
    <h1 class="text-2xl font-semibold text-gray-800 text-center lg:block hidden mt-8">Checkout</h1>

    <div class="grid lg:grid-cols-3 gap-6 mt-6">

      <!-- Left Column -->
      <div class="lg:col-span-2 space-y-6 mt-12">

        <!-- Mobile Savings -->
        <div class="lg:hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm font-medium mt-4">
          You're saving <span id="mobile-savings">₹0</span> on this order
        </div>

        <!-- Items -->
        <div class="bg-white rounded-xl shadow-sm border">
          <div class="p-5 flex justify-between items-center border-b">
            <h3 class="font-semibold text-gray-800 flex items-center text-lg">
              <i class="fas fa-shopping-bag mr-3 text-pink-600"></i>
              <span class="lg:hidden"><span id="mobile-item-count">0</span> ITEMS • ₹<span id="mobile-total">0</span></span>
              <span class="hidden lg:block">Your Items (<span id="item-count">0</span>)</span>
            </h3>
            <span class="text-xs text-gray-500 hidden lg:block">
              <i class="fas fa-info-circle mr-1"></i> Scroll to see more items
            </span>
          </div>
          <div id="order-items-container" class="p-4">
            <div id="order-items" class="space-y-4"></div>
          </div>
        </div>

         <!-- Delivery Address Section -->
        <div class="bg-white rounded-xl shadow-sm border p-5 mt-12">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold text-gray-800 flex items-center text-lg">
              <i class="fas fa-map-marker-alt text-pink-600 mr-2"></i> Delivery Address
            </h3>
            <button id="add-address-btn" class="text-pink-600 text-sm font-medium hover:underline">
              + Add New
            </button>
          </div>

          <div id="addresses-container" class="space-y-3">
            <div id="no-address-msg" class="text-center py-8 text-gray-400">
              <i class="fas fa-home text-3xl mb-2 text-gray-300"></i>
              <p class="text-sm italic">No address saved yet</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="space-y-6">

        <!-- Desktop Order Summary -->
        <div class="bg-white rounded-xl shadow-sm border mt-20">
          <div class="p-5 border-b">
            <h3 class="font-semibold flex items-center">
              <i class="fas fa-receipt mr-3 text-[#1581BF]"></i> Order Summary
            </h3>
          </div>
          <div class="p-5 space-y-3 text-sm">
            <div class="flex justify-between"><span>Subtotal</span><span id="subtotal">₹0</span></div>
            <div class="flex justify-between"><span>Shipping</span><span id="shipping">₹49</span></div>
            <div class="flex justify-between text-green-600 font-medium"><span>Discount</span><span id="discount">-₹0</span></div>
            <hr class="my-3">
            <div class="flex justify-between text-lg font-bold">
              <span>Total</span><span class="text-[#1581BF]" id="total">₹0</span>
            </div>
          </div>
        </div>

        <!-- Payment Options Section -->
        <div class="bg-white rounded-xl shadow-sm border p-5">
          <div class="flex items-center mb-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1581BF] flex items-center justify-center mr-3">
              <i class="fas fa-credit-card text-white text-lg"></i>
            </div>
            <div>
              <h3 class="font-semibold text-gray-800">Payment Method</h3>
              <p class="text-xs text-gray-600">Choose your preferred payment option</p>
            </div>
          </div>
          
          <div class="space-y-2">
            <!-- UPI QR Payment Option -->
            <label class="payment-option flex items-center p-3 border-2 rounded-xl cursor-pointer border-gray-300 hover:border-[#70B2B2] transition-all">
              <input type="radio" name="payment_method" value="qr" class="mr-4" checked>
              <div class="flex-1">
                <div class="font-semibold flex items-center text-gray-800">
                  <i class="fas fa-qrcode mr-2 text-[#70B2B2]"></i> Scan & Pay (UPI QR)
                </div>
                <p class="text-xs text-gray-600 mt-1">Fast, secure & recommended</p>
              </div>
              <div class="w-12 h-12 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-qrcode text-[#70B2B2] text-xl"></i>
              </div>
            </label>

            <!-- Cash on Delivery Option -->
            <label class="payment-option flex items-center p-3 border-2 rounded-xl cursor-pointer border-gray-300 hover:border-[#70B2B2] transition-all">
              <input type="radio" name="payment_method" value="cod" class="mr-4">
              <div class="flex-1">
                <div class="font-semibold flex items-center text-gray-800">
                  <i class="fas fa-rupee-sign mr-2 text-[#70B2B2]"></i> Cash on Delivery (COD)
                </div>
                <p class="text-xs text-gray-600 mt-1">Pay when you receive the order</p>
              </div>
              <div class="w-12 h-12 bg-gradient-to-br from-green-50 to-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-money-bill-wave text-[#70B2B2] text-xl"></i>
              </div>
            </label>
          </div>
          
          <div class="mt-4 text-xs text-gray-500">
            <i class="fas fa-shield-alt mr-1"></i> Your payment is secure with 256-bit SSL encryption
          </div>
        </div>

        <!-- Mobile Order Summary -->
        <div class="lg:hidden bg-white rounded-xl shadow-sm border p-5 space-y-4 mt-4">
          <h3 class="font-semibold text-gray-800 flex items-center text-lg">
            <i class="fas fa-receipt mr-3 text-green-600"></i> Order Summary
          </h3>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between"><span>Subtotal</span><span id="mobile-subtotal">₹0</span></div>
            <div class="flex justify-between"><span>Shipping</span><span id="mobile-shipping">₹49</span></div>
            <div class="flex justify-between text-green-600 font-medium"><span>Discount</span><span id="mobile-discount">-₹0</span></div>
            <hr class="my-3">
            <div class="flex justify-between text-lg font-bold">
              <span>Total</span>
              <span class="text-pink-600 text-xl" id="mobile-total-amount">₹0</span>
            </div>
          </div>
        </div>

        <!-- Mobile Payment -->
        <div class="lg:hidden bg-white rounded-xl shadow-sm border p-6 space-y-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <span class="w-8 h-8 rounded-full border-2 border-pink-600 text-pink-600 flex items-center justify-center text-sm font-bold">3</span>
              <h3 class="ml-3 font-semibold">Payment Options</h3>
            </div>
          </div>

          <div class="space-y-4">
            <h4 class="text-xs font-medium text-gray-600 uppercase tracking-wider">Select Payment Method</h4>

            <label class="flex items-center p-5 border-2 rounded-xl cursor-pointer hover:border-pink-600 transition-all border-gray-300">
              <input type="radio" name="payment_method" value="cod" class="mr-4">
              <div class="flex-1">
                <div class="font-semibold flex items-center"><i class="fas fa-rupee-sign mr-2"></i> Cash on Delivery (COD)</div>
                <p class="text-xs text-gray-600 mt-1">Pay when you receive the order</p>
              </div>
              <i class="fas fa-truck text-pink-600 text-xl"></i>
            </label>

            <label class="flex items-center p-5 border-2 rounded-xl cursor-pointer hover:border-pink-600 transition-all border-pink-600 bg-pink-50">
              <input type="radio" name="payment_method" value="qr" class="mr-4" checked>
              <div class="flex-1">
                <div class="font-semibold flex items-center"><i class="fas fa-qrcode mr-2"></i> Scan & Pay (UPI QR)</div>
                <p class="text-xs text-gray-600 mt-1">Fastest • Recommended</p>
              </div>
              <img src="https://via.placeholder.com/50x50/6366F1/FFFFFF?text=QR" class="w-12 h-12 rounded-lg">
            </label>
          </div>

          <button id="mobile-place-order-btn" class="w-full bg-pink-600 text-white font-bold py-4 rounded-lg text-lg opacity-60 cursor-not-allowed" disabled>
            PLACE ORDER • ₹<span id="mobile-pay-amount">0</span>
          </button>

          <div id="no-address-warning" class="text-center text-sm text-red-600 font-medium">
            Please select a delivery address first
          </div>
        </div>

        <!-- Desktop Place Order -->
        <div class="hidden lg:block bg-white rounded-xl shadow-sm border p-6">
          <button id="desktop-place-order-btn" class="w-full bg-pink-600 text-white font-bold py-4 rounded-lg text-lg hover:bg-pink-700 transition opacity-60 cursor-not-allowed" disabled>
            PLACE ORDER • ₹<span id="desktop-pay-amount">0</span>
          </button>
          <div id="desktop-address-warning" class="text-center text-sm text-red-600 font-medium mt-3">
            Please select a delivery address first
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Address Modal -->
  <div id="address-modal" class="fixed items-center inset-0 bg-black bg-opacity-60 z-50 p-4">
    <div class="bg-gray-100 rounded-xl shadow-xl max-w-lg w-full max-h-screen overflow-y-auto">
      <div class="p-6 border-b flex justify-between items-center">
        <h2 class="text-xl font-bold" id="modal-title">Add New Address</h2>
        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times text-2xl"></i></button>
      </div>
      <form id="address-form" class="p-6 space-y-4">
        <input type="hidden" id="edit-index" value="-1">
        <div class="grid grid-cols-2 gap-4">
          <input type="text" name="fullName" placeholder="Full Name *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
          <input type="text" name="mobile" placeholder="Mobile Number *" required pattern="[0-9]{10}" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        </div>
        <input type="text" name="flat" placeholder="Flat / House No / Floor *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        <input type="text" name="area" placeholder="Area / Street / Locality *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        <div class="grid grid-cols-2 gap-4">
          <input type="text" name="city" placeholder="City *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
          <input type="text" name="state" placeholder="State *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        </div>
        <input type="text" name="pincode" placeholder="Pincode *" required pattern="[0-9]{6}" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        <div class="flex gap-4 pt-4">
          <button type="submit" class="flex-1 bg-pink-600 text-white font-bold py-3 rounded-lg hover:bg-pink-700">Save Address</button>
          <button type="button" id="cancel-modal-btn" class="flex-1 bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script>
    function loadHeader() {
        fetch('../Header/header.html')
            .then(r => { if (!r.ok) throw r; return r.text(); })
            .then(html => {
                document.getElementById('header-placeholder').innerHTML = html;
                const script = document.createElement('script');
                script.src = '../Header/header.js';
                script.onload = () => console.log('Header JS loaded');
                document.body.appendChild(script);
            })
            .catch(err => console.error('Header load failed:', err));
    }

    function loadFooter() {
        fetch('../Footer/footer.html')
            .then(r => { if (!r.ok) throw r; return r.text(); })
            .then(html => {
                document.getElementById('footer-placeholder').innerHTML = html;
            })
            .catch(err => console.error('Footer load failed:', err));
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadHeader();
        loadFooter();
        // ... rest of your code
    });
  </script>

  <!-- JavaScript -->
  <script>
    const STORAGE = { CART: 'cart', ADDRESSES: 'user_addresses', SELECTED: 'selected_address_index' };

    class CheckoutApp {
      constructor() { 
        this.cart = []; 
        this.addresses = []; 
        this.selectedIdx = -1; 
        this.init(); 
      }

      init() { 
        this.loadFromStorage(); 
        this.setupEventListeners(); 
        this.render(); 
      }

      loadFromStorage() {
        try {
          this.cart = JSON.parse(localStorage.getItem(STORAGE.CART)) || [];
          this.addresses = JSON.parse(localStorage.getItem(STORAGE.ADDRESSES)) || [];
          this.selectedIdx = parseInt(localStorage.getItem(STORAGE.SELECTED), 10) || -1;
          if (isNaN(this.selectedIdx)) this.selectedIdx = -1;
        } catch (e) { 
          this.cart = []; 
          this.addresses = []; 
          this.selectedIdx = -1; 
        }
      }

      saveCart() {
        localStorage.setItem(STORAGE.CART, JSON.stringify(this.cart));
        this.renderCart();
      }

      saveAddresses() { localStorage.setItem(STORAGE.ADDRESSES, JSON.stringify(this.addresses)); }
      saveSelected() { localStorage.setItem(STORAGE.SELECTED, this.selectedIdx); }

      isDuplicateAddress(newAddr) {
        return this.addresses.some(addr => 
          addr.fullName.trim() === newAddr.fullName.trim() &&
          addr.mobile.trim() === newAddr.mobile.trim() &&
          addr.flat.trim() === newAddr.flat.trim() &&
          addr.area.trim() === newAddr.area.trim() &&
          addr.city.trim() === newAddr.city.trim() &&
          addr.state.trim() === newAddr.state.trim() &&
          addr.pincode.trim() === newAddr.pincode.trim()
        );
      }

      selectAddress(index) {
        this.selectedIdx = (index >= 0 && index < this.addresses.length) ? index : -1;
        this.saveSelected();
        this.renderAddresses();
        this.updatePaymentSection();
      }

      addAddress(addr) {
        if (this.isDuplicateAddress(addr)) { 
          alert("This address is already saved"); 
          return; 
        }
        this.addresses.push(addr);
        this.selectedIdx = this.addresses.length - 1;
        this.saveAddresses(); 
        this.saveSelected();
        this.renderAddresses(); 
        this.updatePaymentSection();
      }

      updateAddress(index, addr) {
        if (index < 0 || index >= this.addresses.length) return;
        const isSame = JSON.stringify(this.addresses[index]) === JSON.stringify(addr);
        if (!isSame && this.isDuplicateAddress(addr)) { 
          alert("This address is already saved"); 
          return; 
        }
        this.addresses[index] = addr;
        this.saveAddresses(); 
        this.renderAddresses(); 
        this.updatePaymentSection();
      }

      deleteAddress(index) {
        if (!confirm('Delete this address?')) return;
        this.addresses.splice(index, 1);
        if (this.selectedIdx >= this.addresses.length) this.selectedIdx = this.addresses.length > 0 ? 0 : -1;
        this.saveAddresses(); 
        this.saveSelected();
        this.renderAddresses(); 
        this.updatePaymentSection();
      }

      updateItemQuantity(index, newQuantity) {
        if (index < 0 || index >= this.cart.length) return;
        
        // Ensure quantity is between 1 and 10
        newQuantity = Math.max(1, Math.min(10, parseInt(newQuantity) || 1));
        
        this.cart[index].quantity = newQuantity;
        this.saveCart();
      }

      deleteCartItem(index) {
        if (!confirm('Remove this item from cart?')) return;
        this.cart.splice(index, 1);
        this.saveCart();
      }

      render() { 
        this.renderCart(); 
        this.renderAddresses(); 
        this.updatePaymentSection(); 
      }

      renderCart() {
        const container = document.getElementById('order-items');
        const itemsContainer = document.getElementById('order-items-container');
        
        if (!this.cart.length) {
          container.innerHTML = `<div class="text-center text-gray-500 py-10">Your cart is empty.</div>`;
          this.updateTotals(0, 0, 0); 
          itemsContainer.classList.remove('no-scroll');
          return;
        }

        let subtotal = 0, totalItems = 0, totalSavings = 0;
        container.innerHTML = '';

        this.cart.forEach((item, i) => {
          const qty = item.quantity || 1;
          const total = item.price * qty;
          subtotal += total; 
          totalItems += qty;
          const original = Math.round(item.price * 2.5);
          totalSavings += (original - item.price) * qty;

          const div = document.createElement('div');
          div.className = "flex gap-4 p-4 bg-gray-50 rounded-lg transition-all hover:bg-gray-100 relative";
          div.innerHTML = `
            <img src="${item.image || 'https://via.placeholder.com/80'}" class="w-20 h-20 rounded-lg object-cover border border-gray-200">
            
            <div class="flex-1">
              <p class="font-medium text-sm text-gray-800">${item.name}</p>
              <p class="text-xs text-gray-600 mt-1">Size: ${item.size || 'M'}</p>
              <div class="flex items-center gap-3 mt-2">
                <span class="font-bold text-pink-600">₹${item.price}</span>
                <span class="text-xs text-gray-500 line-through">₹${item.originalPrice}</span>
                <span class="bg-green-100 text-green-700 text-xs font-medium px-2 py-1 rounded-full">${item.discount}% OFF</span>
              </div>
              
              <div class="mt-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <!-- Quantity Selector -->
                  <div class="quantity-selector">
                    <button class="qty-btn decrease" data-index="${i}">-</button>
                    <input type="text" class="qty-value" value="${qty}" data-index="${i}" readonly>
                    <button class="qty-btn increase" data-index="${i}">+</button>
                  </div>
                  
                  <!-- Delete Button -->
                  <button class="delete-btn item-delete-btn" data-index="${i}" title="Remove item">
                    <i class="fas fa-trash text-sm"></i>
                  </button>
                </div>
                
                <div class="text-right">
                  <div class="text-sm text-gray-500 mb-1">
                    <span class="font-medium">${qty} × ₹${item.price}</span>
                  </div>
                  <div>
                    <span class="text-lg font-bold text-gray-900">₹${total}</span>
                  </div>
                </div>
              </div>
            </div>`;
          container.appendChild(div);
        });

        // Add or remove scroll class based on item count
        if (this.cart.length > 3) {
          itemsContainer.classList.remove('no-scroll');
        } else {
          itemsContainer.classList.add('no-scroll');
        }

        const shipping = subtotal >= 799 ? 0 : 49;
        const total = subtotal + shipping;
        this.updateTotals(totalItems, subtotal, totalSavings, total, shipping);
      }

      updateTotals(items, subtotal, savings, total, shipping) {
        document.getElementById('item-count').textContent = items;
        document.getElementById('mobile-item-count').textContent = items;
        document.getElementById('mobile-total').textContent = total;
        document.getElementById('mobile-pay-amount').textContent = total;
        document.getElementById('desktop-pay-amount').textContent = total;
        document.getElementById('subtotal').textContent = `₹${subtotal}`;
        document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : `₹${shipping}`;
        document.getElementById('discount').textContent = `-₹${savings}`;
        document.getElementById('total').textContent = `₹${total}`;
        document.getElementById('mobile-savings').textContent = `₹${savings}`;
        document.getElementById('mobile-subtotal').textContent = `₹${subtotal}`;
        document.getElementById('mobile-shipping').textContent = shipping === 0 ? 'FREE' : `₹${shipping}`;
        document.getElementById('mobile-discount').textContent = `-₹${savings}`;
        document.getElementById('mobile-total-amount').textContent = `₹${total}`;
      }

      renderAddresses() {
        const container = document.getElementById('addresses-container');
        const noMsg = document.getElementById('no-address-msg');

        Array.from(container.children).forEach(child => {
          if (child.id !== 'no-address-msg') child.remove();
        });

        if (this.addresses.length === 0) {
          noMsg.style.display = 'block';
          return;
        }
        noMsg.style.display = 'none';

        this.addresses.forEach((addr, i) => {
          const isSelected = this.selectedIdx === i;

          const card = document.createElement('div');
          card.className = `address-card border-2 rounded-xl p-4 mt-10 cursor-pointer transition-all duration-200 
            ${isSelected ? 'border-pink-600 bg-pink-50 shadow-lg' : 'border-gray-200 hover:border-pink-300'}`;

          card.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-full ${isSelected ? 'bg-pink-600' : 'bg-gray-200'} flex items-center justify-center text-white">
                <i class="fas fa-map-marker-alt text-lg"></i>
              </div>

              <div class="flex-1 min-w-0 select-address" data-index="${i}">
                <div class="flex items-center gap-2 flex-wrap">
                  <p class="font-semibold text-gray-900">${addr.fullName}</p>
                  <span class="px-2 py-0.5 text-xs rounded-full ${isSelected ? 'bg-pink-600 text-white' : 'bg-gray-200 text-gray-700'}">Home</span>
                </div>
                <p class="text-xs text-gray-600 mt-1">
                  ${addr.flat}, ${addr.area}, ${addr.city} - ${addr.pincode}
                </p>
                <p class="text-xs text-gray-500"><i class="fas fa-phone-alt"></i> ${addr.mobile}</p>
                
                ${isSelected ? `
                  <div class="mt-2 text-green-600 font-semibold text-sm flex items-center">
                    <i class="fas fa-check-circle mr-1.5"></i>
                    Delivering Here
                  </div>
                ` : ''}
              </div>

              <div class="flex gap-1">
                <button type="button" class="edit-btn p-2 hover:bg-gray-100 rounded-lg" data-index="${i}">
                  <i class="fas fa-edit text-gray-600 text-sm"></i>
                </button>
                <button type="button" class="delete-btn p-2 hover:bg-red-50 rounded-lg" data-index="${i}">
                  <i class="fas fa-trash-alt text-red-500 text-sm"></i>
                </button>
              </div>
            </div>
          `;

          container.appendChild(card);
        });
      }

      updatePaymentSection() {
        const hasAddr = this.selectedIdx !== -1;
        const mobileBtn = document.getElementById('mobile-place-order-btn');
        const desktopBtn = document.getElementById('desktop-place-order-btn');
        const mobileWarn = document.getElementById('no-address-warning');
        const desktopWarn = document.getElementById('desktop-address-warning');
        const codInputs = document.querySelectorAll('input[value="cod"]');

        if (hasAddr) {
          mobileBtn.disabled = false; 
          mobileBtn.classList.remove('opacity-60', 'cursor-not-allowed');
          desktopBtn.disabled = false; 
          desktopBtn.classList.remove('opacity-60', 'cursor-not-allowed');
          mobileWarn.style.display = 'none'; 
          desktopWarn.style.display = 'none';
          // Enable COD option when address is selected
          codInputs.forEach(input => {
            input.disabled = false;
            input.closest('label').classList.remove('opacity-60', 'cursor-not-allowed');
          });
        } else {
          mobileBtn.disabled = true; 
          mobileBtn.classList.add('opacity-60', 'cursor-not-allowed');
          desktopBtn.disabled = true; 
          desktopBtn.classList.add('opacity-60', 'cursor-not-allowed');
          mobileWarn.style.display = 'block'; 
          desktopWarn.style.display = 'block';
          // Disable COD option when no address is selected
          codInputs.forEach(input => {
            input.disabled = true;
            input.closest('label').classList.add('opacity-60', 'cursor-not-allowed');
          });
        }
      }

      openModal(editIndex = -1) {
        document.getElementById('edit-index').value = editIndex;
        document.getElementById('modal-title').textContent = editIndex === -1 ? 'Add New Address' : 'Edit Address';
        const form = document.getElementById('address-form');
        if (editIndex === -1) form.reset();
        else {
          const addr = this.addresses[editIndex];
          if (addr) Object.keys(addr).forEach(k => { if (form[k]) form[k].value = addr[k]; });
        }
        document.getElementById('address-modal').classList.add('show');
      }

      closeModal() { document.getElementById('address-modal').classList.remove('show'); }

      setupEventListeners() {
        document.getElementById('add-address-btn').addEventListener('click', () => this.openModal(-1));
        document.getElementById('close-modal-btn').addEventListener('click', () => this.closeModal());
        document.getElementById('cancel-modal-btn').addEventListener('click', () => this.closeModal());
        document.getElementById('address-modal').addEventListener('click', e => { 
          if (e.target.id === 'address-modal') this.closeModal(); 
        });
        document.addEventListener('keydown', e => { 
          if (e.key === 'Escape') this.closeModal(); 
        });

        document.getElementById('address-form').addEventListener('submit', e => {
          e.preventDefault();
          const fd = new FormData(e.target);
          const addr = {
            fullName: fd.get('fullName').trim(),
            mobile: fd.get('mobile').trim(),
            flat: fd.get('flat').trim(),
            area: fd.get('area').trim(),
            city: fd.get('city').trim(),
            state: fd.get('state').trim(),
            pincode: fd.get('pincode').trim()
          };
          const editIdx = parseInt(document.getElementById('edit-index').value, 10);
          editIdx >= 0 ? this.updateAddress(editIdx, addr) : this.addAddress(addr);
          this.closeModal();
        });

        document.getElementById('mobile-place-order-btn').addEventListener('click', () => this.placeOrder());
        document.getElementById('desktop-place-order-btn').addEventListener('click', () => this.placeOrder());

        // Quantity and delete buttons event delegation
        document.getElementById('order-items').addEventListener('click', e => {
          // Quantity decrease button
          if (e.target.classList.contains('decrease') || e.target.closest('.decrease')) {
            const btn = e.target.classList.contains('decrease') ? e.target : e.target.closest('.decrease');
            const index = parseInt(btn.dataset.index, 10);
            const currentQty = this.cart[index].quantity || 1;
            if (currentQty > 1) {
              this.updateItemQuantity(index, currentQty - 1);
            }
          }
          
          // Quantity increase button
          if (e.target.classList.contains('increase') || e.target.closest('.increase')) {
            const btn = e.target.classList.contains('increase') ? e.target : e.target.closest('.increase');
            const index = parseInt(btn.dataset.index, 10);
            const currentQty = this.cart[index].quantity || 1;
            if (currentQty < 10) {
              this.updateItemQuantity(index, currentQty + 1);
            }
          }
          
          // Delete item button
          if (e.target.classList.contains('item-delete-btn') || e.target.closest('.item-delete-btn')) {
            const btn = e.target.classList.contains('item-delete-btn') ? e.target : e.target.closest('.item-delete-btn');
            const index = parseInt(btn.dataset.index, 10);
            this.deleteCartItem(index);
          }
        });

        // Quantity input direct editing
        document.getElementById('order-items').addEventListener('change', e => {
          if (e.target.classList.contains('qty-value')) {
            const index = parseInt(e.target.dataset.index, 10);
            const newQty = parseInt(e.target.value, 10) || 1;
            this.updateItemQuantity(index, newQty);
          }
        });

        // Quantity input validation
        document.getElementById('order-items').addEventListener('input', e => {
          if (e.target.classList.contains('qty-value')) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            const value = parseInt(e.target.value, 10);
            if (value > 10) e.target.value = '10';
            if (value < 1) e.target.value = '1';
          }
        });

        // Address container events
        document.getElementById('addresses-container').addEventListener('click', e => {
          const editBtn = e.target.closest('.edit-btn');
          const deleteBtn = e.target.closest('.delete-btn');
          const selectArea = e.target.closest('.select-address');
          if (editBtn) { 
            this.openModal(parseInt(editBtn.dataset.index, 10)); 
            return; 
          }
          if (deleteBtn) { 
            this.deleteAddress(parseInt(deleteBtn.dataset.index, 10)); 
            return; 
          }
          if (selectArea) { 
            this.selectAddress(parseInt(selectArea.dataset.index, 10)); 
          }
        });

        // Payment option selection styling
        document.querySelectorAll('input[name="payment_method"]').forEach(input => {
          input.addEventListener('change', (e) => {
            // Remove selected class from all labels
            document.querySelectorAll('.payment-option').forEach(label => {
              label.classList.remove('selected', 'border-[#70B2B2]', 'bg-[#f0f9f9]');
              label.classList.add('border-gray-300');
            });
            
            // Add selected class to the selected label
            if (e.target.checked) {
              const label = e.target.closest('.payment-option');
              if (label) {
                label.classList.add('selected', 'border-[#70B2B2]', 'bg-[#f0f9f9]');
                label.classList.remove('border-gray-300');
              }
            }
          });
        });

        // Initialize payment option styling
        const initialSelected = document.querySelector('input[name="payment_method"]:checked');
        if (initialSelected) {
          const label = initialSelected.closest('.payment-option');
          if (label) {
            label.classList.add('selected', 'border-[#70B2B2]', 'bg-[#f0f9f9]');
            label.classList.remove('border-gray-300');
          }
        }
      }

      placeOrder() {
        if (this.selectedIdx === -1) return alert('Please select a delivery address!');
        const method = document.querySelector('input[name="payment_method"]:checked').value;
        alert(`Order Placed Successfully!\nPayment: ${method === 'cod' ? 'Cash on Delivery' : 'UPI QR'}`);
        localStorage.removeItem(STORAGE.CART);
        window.location.href = 'order-success.html';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!localStorage.getItem(STORAGE.CART)) {
        localStorage.setItem(STORAGE.CART, JSON.stringify([
          { name: 'Paracetamol 500mg', price: 60, quantity: 2, size: '1 strip', image: 'https://via.placeholder.com/80' },
          { name: 'Vitamin C 1000mg', price: 250, quantity: 1, size: '1 bottle', image: 'https://via.placeholder.com/80' },
          { name: 'Bandages 10pc', price: 120, quantity: 1, size: '10 pack', image: 'https://via.placeholder.com/80' },
          { name: 'Hand Sanitizer', price: 180, quantity: 1, size: '500ml', image: 'https://via.placeholder.com/80' }
        ]));
      }

      new CheckoutApp();
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediCart - Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../Footer/footer.css">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8fafc; }
    #address-modal { display: none; }
    #order-success-modal { display: none; }
    #address-modal.show { display: flex !important; }
    #order-success-modal.show { display: flex !important; }
    
    /* Custom scrollbar for items container */
    #order-items-container {
      max-height: 420px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #F875AA #f8fafc;
    }
    
    #order-items-container::-webkit-scrollbar {
      width: 6px;
    }
    
    #order-items-container::-webkit-scrollbar-track {
      background: #f8fafc;
      border-radius: 10px;
    }
    
    #order-items-container::-webkit-scrollbar-thumb {
      background: #F875AA;
      border-radius: 10px;
    }
    
    #order-items-container::-webkit-scrollbar-thumb:hover {
      background: #F875AA;
    }
    
    /* Hide scrollbar when less than 3 items */
    #order-items-container.no-scroll {
      overflow-y: hidden;
      max-height: none;
    }
    
    /* Smooth transitions */
    .transition-all { transition: all 0.3s ease; }
    
    /* Quantity selector styles */
    .quantity-selector {
      display: flex;
      align-items: center;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      width: fit-content;
    }
    
    .qty-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 600;
    }
    
    .qty-btn:hover {
      background: #f3f4f6;
    }
    
    .qty-btn.decrease {
      border-right: 1px solid #e5e7eb;
    }
    
    .qty-btn.increase {
      border-left: 1px solid #e5e7eb;
    }
    
    .qty-value {
      width: 40px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      border: none;
      background: rgb(255, 255, 255);
      padding: 6px 0;
    }
    
    .qty-value:focus {
      outline: none;
      background: #fef3f7;
    }
    
    /* Delete button styles */
    .delete-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: 1px solid #fecaca;
      color: #ef4444;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .delete-btn:hover {
      background: #fef2f2;
      transform: scale(1.05);
    }
    
    /* Item quantity indicator */
    .item-quantity-indicator {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #F875AA;
      color: white;
      font-size: 11px;
      font-weight: 600;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Payment option styles */
    .payment-option {
      transition: all 0.3s ease;
    }
    
    .payment-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .payment-option.selected {
      border-color: #70B2B2;
      background-color: #f0f9f9;
    }
    
    /* Order success modal styles */
    .confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9998;
    }
    
    .success-checkmark {
      width: 80px;
      height: 80px;
      margin: 0 auto;
      position: relative;
    }
    
    .success-checkmark .check-icon {
      width: 80px;
      height: 80px;
      position: relative;
      border-radius: 50%;
      box-sizing: content-box;
      border: 4px solid #4CAF50;
    }
    
    .success-checkmark .check-icon::before {
      top: 3px;
      left: -2px;
      width: 30px;
      transform-origin: 100% 50%;
      border-radius: 100px 0 0 100px;
    }
    
    .success-checkmark .check-icon::after {
      top: 0;
      left: 30px;
      width: 60px;
      transform-origin: 0 50%;
      border-radius: 0 100px 100px 0;
      animation: rotate-circle 4.25s ease-in;
    }
    
    .success-checkmark .check-icon .icon-line {
      height: 5px;
      background-color: #4CAF50;
      display: block;
      border-radius: 2px;
      position: absolute;
      z-index: 10;
    }
    
    .success-checkmark .check-icon .icon-line.line-tip {
      top: 46px;
      left: 14px;
      width: 25px;
      transform: rotate(45deg);
      animation: icon-line-tip 0.75s;
    }
    
    .success-checkmark .check-icon .icon-line.line-long {
      top: 38px;
      right: 8px;
      width: 47px;
      transform: rotate(-45deg);
      animation: icon-line-long 0.75s;
    }
    
    .success-checkmark .icon-circle {
      position: absolute;
      left: 0;
      top: 0;
      z-index: 10;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      box-sizing: content-box;
      border: 4px solid rgba(76, 175, 80, 0.5);
    }
    
    @keyframes rotate-circle {
      0% { transform: rotate(-45deg); }
      5% { transform: rotate(-45deg); }
      12% { transform: rotate(-405deg); }
      100% { transform: rotate(-405deg); }
    }
    
    @keyframes icon-line-tip {
      0% { width: 0; left: 1px; top: 19px; }
      54% { width: 0; left: 1px; top: 19px; }
      70% { width: 50px; left: -8px; top: 37px; }
      84% { width: 17px; left: 21px; top: 48px; }
      100% { width: 25px; left: 14px; top: 45px; }
    }
    
    @keyframes icon-line-long {
      0% { width: 0; right: 46px; top: 54px; }
      65% { width: 0; right: 46px; top: 54px; }
      84% { width: 55px; right: 0px; top: 35px; }
      100% { width: 47px; right: 8px; top: 38px; }
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="bg-[#F0F0F0]">

  <div id="header-placeholder"></div>

  <main class="container mx-auto px-4 py-6 mt-16 max-w-6xl">
    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas" class="confetti-canvas"></canvas>

    <div class="grid lg:grid-cols-3 gap-6 mt-24">

      <!-- Left Column -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Mobile Savings Banner -->
        <div class="lg:hidden bg-gradient-to-r from-pink-50 to-purple-50 border border-pink-200 px-4 py-3 rounded-lg text-sm font-medium">
          <div class="flex items-center">
            <i class="fas fa-gift text-pink-600 mr-2"></i>
            <span class="font-semibold">You're saving <span id="mobile-savings">₹0</span> on this order!</span>
          </div>
        </div>

        <!-- Items Section -->
        <div class="bg-white rounded-xl shadow-sm border">
          <div class="p-5 flex justify-between items-center border-b">
            <h3 class="font-semibold text-gray-800 flex items-center text-lg">
              <i class="fas fa-shopping-bag mr-3 text-pink-600"></i>
              Your Items (<span id="item-count">0</span>)
            </h3>
            <span class="text-xs text-gray-500 hidden lg:block">
              <i class="fas fa-info-circle mr-1"></i> Scroll to see more items
            </span>
          </div>
          <div id="order-items-container" class="p-4">
            <div id="order-items" class="space-y-4"></div>
          </div>
        </div>

        <!-- Delivery Address Section -->
        <div class="bg-white rounded-xl shadow-sm border p-5">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold text-gray-800 flex items-center text-lg">
              <i class="fas fa-map-marker-alt text-pink-600 mr-2"></i> Delivery Address
            </h3>
            <button id="add-address-btn" class="text-pink-600 text-sm font-medium hover:underline flex items-center">
              <i class="fas fa-plus mr-1"></i> Add New
            </button>
          </div>

          <div id="addresses-container" class="space-y-3">
            <div id="no-address-msg" class="text-center py-8 text-gray-400">
              <i class="fas fa-home text-3xl mb-2 text-gray-300"></i>
              <p class="text-sm italic">No address saved yet</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - DESKTOP ONLY -->
      <div class="hidden lg:block space-y-6 mt-6">

        <!-- Desktop Order Summary -->
        <div class="bg-white rounded-xl shadow-sm border">
          <div class="p-5 border-b">
            <h3 class="font-semibold flex items-center text-gray-800">
              <i class="fas fa-receipt mr-3 text-[#1581BF]"></i> Order Summary
            </h3>
          </div>
          <div class="p-5 space-y-3 text-sm">
            <div class="flex justify-between"><span>Subtotal</span><span id="subtotal">₹0</span></div>
            <div class="flex justify-between"><span>Shipping</span><span id="shipping">₹49</span></div>
            <div class="flex justify-between text-green-600 font-medium"><span>Discount</span><span id="discount">-₹0</span></div>
            <hr class="my-3">
            <div class="flex justify-between text-lg font-bold">
              <span>Total</span><span class="text-[#1581BF]" id="total">₹0</span>
            </div>
          </div>
        </div>

        <!-- Desktop Payment Options -->
        <div class="bg-white rounded-xl shadow-sm border p-5">
          <div class="flex items-center mb-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#1581BF] flex items-center justify-center mr-3">
              <i class="fas fa-credit-card text-white text-lg"></i>
            </div>
            <div>
              <h3 class="font-semibold text-gray-800">Payment Method</h3>
              <p class="text-xs text-gray-600">Choose your preferred payment option</p>
            </div>
          </div>
          
          <div class="space-y-2">
            <!-- UPI QR Payment Option -->
            <label class="payment-option flex items-center p-3 border-2 rounded-xl cursor-pointer border-gray-300 hover:border-[#70B2B2] transition-all">
              <input type="radio" name="payment_method" value="qr" class="mr-4" checked>
              <div class="flex-1">
                <div class="font-semibold flex items-center text-gray-800">
                  <i class="fas fa-qrcode mr-2 text-[#70B2B2]"></i> Scan & Pay (UPI QR)
                </div>
                <p class="text-xs text-gray-600 mt-1">Fast, secure & recommended</p>
              </div>
              <div class="w-12 h-12 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-qrcode text-[#70B2B2] text-xl"></i>
              </div>
            </label>

            <!-- Cash on Delivery Option -->
            <label class="payment-option flex items-center p-3 border-2 rounded-xl cursor-pointer border-gray-300 hover:border-[#70B2B2] transition-all">
              <input type="radio" name="payment_method" value="cod" class="mr-4">
              <div class="flex-1">
                <div class="font-semibold flex items-center text-gray-800">
                  <i class="fas fa-rupee-sign mr-2 text-[#70B2B2]"></i> Cash on Delivery (COD)
                </div>
                <p class="text-xs text-gray-600 mt-1">Pay when you receive the order</p>
              </div>
              <div class="w-12 h-12 bg-gradient-to-br from-green-50 to-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-money-bill-wave text-[#70B2B2] text-xl"></i>
              </div>
            </label>
          </div>
          
          <div class="mt-4 text-xs text-gray-500">
            <i class="fas fa-shield-alt mr-1"></i> Your payment is secure with 256-bit SSL encryption
          </div>
        </div>

        <!-- Desktop Place Order Button -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
          <button id="desktop-place-order-btn" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold py-4 rounded-lg text-lg hover:from-pink-700 hover:to-purple-700 transition opacity-60 cursor-not-allowed" disabled>
            PLACE ORDER • ₹<span id="desktop-pay-amount">0</span>
          </button>
          <div id="desktop-address-warning" class="text-center text-sm text-red-600 font-medium mt-3">
            Please select a delivery address first
          </div>
        </div>

      </div>

      <!-- Mobile Right Column - Combined Order Summary & Payment -->
      <div class="lg:hidden space-y-6 mt-6">

        <!-- Mobile Order Summary & Payment Combined Card -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          
          <!-- Order Summary Section -->
          <div class="p-5 border-b">
            <h3 class="font-semibold text-gray-800 flex items-center text-lg">
              <i class="fas fa-receipt mr-3 text-[#1581BF]"></i> Order Summary
            </h3>
          </div>
          
          <div class="p-5 space-y-3 text-sm">
            <div class="flex justify-between"><span>Subtotal</span><span id="mobile-subtotal">₹0</span></div>
            <div class="flex justify-between"><span>Shipping</span><span id="mobile-shipping">₹49</span></div>
            <div class="flex justify-between text-green-600 font-medium"><span>Discount</span><span id="mobile-discount">-₹0</span></div>
            <hr class="my-3">
            <div class="flex justify-between text-lg font-bold">
              <span>Total</span>
              <span class="text-pink-600" id="mobile-total-amount">₹0</span>
            </div>
          </div>
          
          <!-- Payment Section Divider -->
          <div class="border-t">
            <div class="p-5">
              <div class="flex items-center mb-4">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-pink-600 to-purple-600 flex items-center justify-center mr-3">
                  <i class="fas fa-credit-card text-white text-lg"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-gray-800">Payment Method</h3>
                  <p class="text-xs text-gray-600">Select how you want to pay</p>
                </div>
              </div>
              
              <div class="space-y-3">
                <!-- UPI QR Option -->
                <label class="flex items-center p-4 border-2 rounded-xl cursor-pointer hover:border-pink-600 transition-all border-pink-600 bg-pink-50">
                  <input type="radio" name="payment_method" value="qr" class="mr-4" checked>
                  <div class="flex-1">
                    <div class="font-semibold flex items-center text-gray-800">
                      <i class="fas fa-qrcode mr-2 text-pink-600"></i> Scan & Pay (UPI QR)
                    </div>
                    <p class="text-xs text-gray-600 mt-1">Fastest • Recommended</p>
                  </div>
                  <div class="w-10 h-10 bg-gradient-to-r from-pink-100 to-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-qrcode text-pink-600"></i>
                  </div>
                </label>
                
                <!-- COD Option -->
                <label class="flex items-center p-4 border-2 rounded-xl cursor-pointer hover:border-green-600 transition-all border-gray-300">
                  <input type="radio" name="payment_method" value="cod" class="mr-4">
                  <div class="flex-1">
                    <div class="font-semibold flex items-center text-gray-800">
                      <i class="fas fa-rupee-sign mr-2 text-green-600"></i> Cash on Delivery
                    </div>
                    <p class="text-xs text-gray-600 mt-1">Pay when you receive</p>
                  </div>
                  <div class="w-10 h-10 bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-money-bill-wave text-green-600"></i>
                  </div>
                </label>
              </div>
              
              <div class="mt-4 text-xs text-gray-500 flex items-center">
                <i class="fas fa-shield-alt mr-2 text-green-500"></i>
                <span>Secure payment with 256-bit encryption</span>
              </div>
            </div>
          </div>
          
          <!-- Place Order Button -->
          <div class="border-t p-5 bg-gray-50">
            <button id="mobile-place-order-btn" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold py-4 rounded-lg text-lg opacity-60 cursor-not-allowed" disabled>
              PLACE ORDER • ₹<span id="mobile-pay-amount">0</span>
            </button>
            <div id="no-address-warning" class="text-center text-sm text-red-600 font-medium mt-3">
              Please select a delivery address first
            </div>
          </div>
          
        </div>

      </div>

    </div>
  </main>

  <!-- Address Modal -->
  <div id="address-modal" class="fixed items-center inset-0 bg-black bg-opacity-60 z-50 p-4">
    <div class="bg-gray-100 rounded-xl shadow-xl max-w-lg w-full max-h-screen overflow-y-auto">
      <div class="p-6 border-b flex justify-between items-center">
        <h2 class="text-xl font-bold" id="modal-title">Add New Address</h2>
        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times text-2xl"></i></button>
      </div>
      <form id="address-form" class="p-6 space-y-4">
        <input type="hidden" id="edit-index" value="-1">
        <div class="grid grid-cols-2 gap-4">
          <input type="text" name="fullName" placeholder="Full Name *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
          <input type="text" name="mobile" placeholder="Mobile Number *" required pattern="[0-9]{10}" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        </div>
        <input type="text" name="flat" placeholder="Flat / House No / Floor *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        <input type="text" name="area" placeholder="Area / Street / Locality *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        <div class="grid grid-cols-2 gap-4">
          <input type="text" name="city" placeholder="City *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
          <input type="text" name="state" placeholder="State *" required class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        </div>
        <input type="text" name="pincode" placeholder="Pincode *" required pattern="[0-9]{6}" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
        <div class="flex gap-4 pt-4">
          <button type="submit" class="flex-1 bg-pink-600 text-white font-bold py-3 rounded-lg hover:bg-pink-700">Save Address</button>
          <button type="button" id="cancel-modal-btn" class="flex-1 bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Order Success Modal -->
  <div id="order-success-modal" class="fixed items-center justify-center inset-0 bg-black bg-opacity-70 z-[10000] p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all">
      <div class="p-8 text-center">
        <!-- Success Animation -->
        <div class="success-checkmark mb-6">
          <div class="check-icon">
            <span class="icon-line line-tip"></span>
            <span class="icon-line line-long"></span>
            <div class="icon-circle"></div>
            <div class="icon-fix"></div>
          </div>
        </div>
        
        <h2 class="text-3xl font-bold text-gray-800 mb-2" id="success-title">Yay! Order Placed Successfully!</h2>
            <p class="text-gray-600 mb-4" id="success-message">Your order will be delivered soon.</p>
            <p class="text-sm text-gray-500 mb-6" id="success-order-id">Order ID: #</p>
            
            <div class="space-y-4">
                <button id="success-ok-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-lg text-lg hover:from-green-600 hover:to-emerald-700 transition-all">
                    <i class="fas fa-home mr-2"></i> Back to Home
                </button>
          
          <a href="./MY ORDERS/myorders.html" class="w-full block">
                    <button class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 rounded-lg text-lg hover:from-blue-600 hover:to-blue-700 transition-all">
                        <i class="fas fa-shopping-bag mr-2"></i> View My Orders
                    </button>
                </a>

                <div class="text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    Thank you for your purchase!
                </div>
        </div>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script>
    function loadHeader() {
        fetch('../Header/header.html')
            .then(r => { if (!r.ok) throw r; return r.text(); })
            .then(html => {
                document.getElementById('header-placeholder').innerHTML = html;
                const script = document.createElement('script');
                script.src = '../Header/header.js';
                script.onload = () => console.log('Header JS loaded');
                document.body.appendChild(script);
            })
            .catch(err => console.error('Header load failed:', err));
    }

    function loadFooter() {
        fetch('../Footer/footer.html')
            .then(r => { if (!r.ok) throw r; return r.text(); })
            .then(html => {
                document.getElementById('footer-placeholder').innerHTML = html;
            })
            .catch(err => console.error('Footer load failed:', err));
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadHeader();
        loadFooter();
    });
  </script>

  <script src="./cart-manager.js"></script>

  <!-- Confetti Library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <!-- JavaScript -->
  <script>
    const STORAGE = { 
        ADDRESSES: 'user_addresses', 
        SELECTED: 'selected_address_index' 
    };

    class CheckoutApp {
        constructor() { 
            this.cart = []; 
            this.addresses = []; 
            this.selectedIdx = -1; 
            this.init(); 
        }

        init() { 
            this.loadFromStorage(); 
            this.setupEventListeners(); 
            this.render(); 
        }

        loadFromStorage() {
            try {
                // Get cart from cart manager
                this.cart = cartManager.getCart();
                this.addresses = JSON.parse(localStorage.getItem(STORAGE.ADDRESSES)) || [];
                this.selectedIdx = parseInt(localStorage.getItem(STORAGE.SELECTED), 10) || -1;
                if (isNaN(this.selectedIdx)) this.selectedIdx = -1;
            } catch (e) { 
                console.error('Error loading from storage:', e);
                this.cart = []; 
                this.addresses = []; 
                this.selectedIdx = -1; 
            }
        }

        saveCart() {
            cartManager.saveCart(this.cart);
            this.renderCart();
        }

      updateCartCount() {
        const totalItems = this.cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
        
        // Update cart count in header if elements exist
        document.querySelectorAll('#desktop-cart-count, #mobile-cart-count, #cart-count, #cartItemsCount, .cart-count').forEach(el => {
          if (el) {
            el.textContent = totalItems;
            el.style.display = totalItems > 0 ? 'inline-flex' : 'none';
          }
        });
        
        // Dispatch storage event to sync across tabs
        window.dispatchEvent(new Event('storage'));
      }

      saveAddresses() { localStorage.setItem(STORAGE.ADDRESSES, JSON.stringify(this.addresses)); }
      saveSelected() { localStorage.setItem(STORAGE.SELECTED, this.selectedIdx); }

      isDuplicateAddress(newAddr) {
        return this.addresses.some(addr => 
          addr.fullName.trim() === newAddr.fullName.trim() &&
          addr.mobile.trim() === newAddr.mobile.trim() &&
          addr.flat.trim() === newAddr.flat.trim() &&
          addr.area.trim() === newAddr.area.trim() &&
          addr.city.trim() === newAddr.city.trim() &&
          addr.state.trim() === newAddr.state.trim() &&
          addr.pincode.trim() === newAddr.pincode.trim()
        );
      }

      selectAddress(index) {
        this.selectedIdx = (index >= 0 && index < this.addresses.length) ? index : -1;
        this.saveSelected();
        this.renderAddresses();
        this.updatePaymentSection();
      }

      addAddress(addr) {
        if (this.isDuplicateAddress(addr)) { 
          alert("This address is already saved"); 
          return; 
        }
        this.addresses.push(addr);
        this.selectedIdx = this.addresses.length - 1;
        this.saveAddresses(); 
        this.saveSelected();
        this.renderAddresses(); 
        this.updatePaymentSection();
      }

      updateAddress(index, addr) {
        if (index < 0 || index >= this.addresses.length) return;
        const isSame = JSON.stringify(this.addresses[index]) === JSON.stringify(addr);
        if (!isSame && this.isDuplicateAddress(addr)) { 
          alert("This address is already saved"); 
          return; 
        }
        this.addresses[index] = addr;
        this.saveAddresses(); 
        this.renderAddresses(); 
        this.updatePaymentSection();
      }

      deleteAddress(index) {
        if (!confirm('Delete this address?')) return;
        this.addresses.splice(index, 1);
        if (this.selectedIdx >= this.addresses.length) this.selectedIdx = this.addresses.length > 0 ? 0 : -1;
        this.saveAddresses(); 
        this.saveSelected();
        this.renderAddresses(); 
        this.updatePaymentSection();
      }

      updateItemQuantity(index, newQuantity) {
        if (index < 0 || index >= this.cart.length) return;
        
        // Ensure quantity is between 1 and 10
        newQuantity = Math.max(1, Math.min(10, parseInt(newQuantity) || 1));
        
        this.cart[index].quantity = newQuantity;
        this.saveCart();
      }

      deleteCartItem(index) {
        if (!confirm('Remove this item from cart?')) return;
        this.cart.splice(index, 1);
        this.saveCart();
      }

      render() { 
        this.renderCart(); 
        this.renderAddresses(); 
        this.updatePaymentSection(); 
      }

      renderCart() {
        const container = document.getElementById('order-items');
        const itemsContainer = document.getElementById('order-items-container');
        
        if (!this.cart.length) {
          container.innerHTML = `<div class="text-center text-gray-500 py-10">Your cart is empty.</div>`;
          this.updateTotals(0, 0, 0); 
          itemsContainer.classList.remove('no-scroll');
          return;
        }

        let subtotal = 0, totalItems = 0, totalSavings = 0;
        container.innerHTML = '';

        this.cart.forEach((item, i) => {
          const qty = item.quantity || 1;
          const price = item.price || 0;
          const total = price * qty;
          subtotal += total; 
          totalItems += qty;
          const original = item.originalPrice || Math.round(price * 1.2);
          totalSavings += (original - price) * qty;

          const div = document.createElement('div');
          div.className = "flex gap-4 p-4 bg-gray-50 rounded-lg transition-all hover:bg-gray-100 relative";
          div.innerHTML = `
            <img src="${item.image || 'https://via.placeholder.com/80'}" class="w-20 h-20 rounded-lg object-cover border border-gray-200">
            
            <div class="flex-1">
              <p class="font-medium text-sm text-gray-800">${item.name || 'Product'}</p>
              <p class="text-xs text-gray-600 mt-1">Size: ${item.size || 'M'}</p>
              <div class="flex items-center gap-3 mt-2">
                <span class="font-bold text-pink-600">₹${price}</span>
                <span class="text-xs text-gray-500 line-through">₹${original}</span>
                <span class="bg-green-100 text-green-700 text-xs font-medium px-2 py-1 rounded-full">${item.discount || 20}% OFF</span>
              </div>
              
              <div class="mt-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <!-- Quantity Selector -->
                  <div class="quantity-selector">
                    <button class="qty-btn decrease" data-index="${i}">-</button>
                    <input type="text" class="qty-value" value="${qty}" data-index="${i}" readonly>
                    <button class="qty-btn increase" data-index="${i}">+</button>
                  </div>
                  
                  <!-- Delete Button -->
                  <button class="delete-btn item-delete-btn" data-index="${i}" title="Remove item">
                    <i class="fas fa-trash text-sm"></i>
                  </button>
                </div>
                
                <div class="text-right">
                  <div class="text-sm text-gray-500 mb-1">
                    <span class="font-medium">${qty} × ₹${price}</span>
                  </div>
                  <div>
                    <span class="text-lg font-bold text-gray-900">₹${total}</span>
                  </div>
                </div>
              </div>
            </div>`;
          container.appendChild(div);
        });

        // Add or remove scroll class based on item count
        if (this.cart.length > 3) {
          itemsContainer.classList.remove('no-scroll');
        } else {
          itemsContainer.classList.add('no-scroll');
        }

        const shipping = subtotal >= 799 ? 0 : 49;
        const total = subtotal + shipping;
        this.updateTotals(totalItems, subtotal, totalSavings, total, shipping);
      }

      updateTotals(items, subtotal, savings, total, shipping) {
        // Update all elements
        document.getElementById('item-count').textContent = items;
        document.getElementById('mobile-savings').textContent = `₹${savings}`;
        
        // Desktop values
        document.getElementById('subtotal').textContent = `₹${subtotal}`;
        document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : `₹${shipping}`;
        document.getElementById('discount').textContent = `-₹${savings}`;
        document.getElementById('total').textContent = `₹${total}`;
        document.getElementById('desktop-pay-amount').textContent = total;
        
        // Mobile values
        document.getElementById('mobile-subtotal').textContent = `₹${subtotal}`;
        document.getElementById('mobile-shipping').textContent = shipping === 0 ? 'FREE' : `₹${shipping}`;
        document.getElementById('mobile-discount').textContent = `-₹${savings}`;
        document.getElementById('mobile-total-amount').textContent = `₹${total}`;
        document.getElementById('mobile-pay-amount').textContent = total;
      }

      renderAddresses() {
        const container = document.getElementById('addresses-container');
        const noMsg = document.getElementById('no-address-msg');

        Array.from(container.children).forEach(child => {
          if (child.id !== 'no-address-msg') child.remove();
        });

        if (this.addresses.length === 0) {
          noMsg.style.display = 'block';
          return;
        }
        noMsg.style.display = 'none';

        this.addresses.forEach((addr, i) => {
          const isSelected = this.selectedIdx === i;

          const card = document.createElement('div');
          card.className = `address-card border-2 rounded-xl p-4 cursor-pointer transition-all duration-200 
            ${isSelected ? 'border-pink-600 bg-pink-50 shadow-lg' : 'border-gray-200 hover:border-pink-300'}`;

          card.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-full ${isSelected ? 'bg-pink-600' : 'bg-gray-200'} flex items-center justify-center text-white">
                <i class="fas fa-map-marker-alt text-lg"></i>
              </div>

              <div class="flex-1 min-w-0 select-address" data-index="${i}">
                <div class="flex items-center gap-2 flex-wrap">
                  <p class="font-semibold text-gray-900">${addr.fullName}</p>
                  <span class="px-2 py-0.5 text-xs rounded-full ${isSelected ? 'bg-pink-600 text-white' : 'bg-gray-200 text-gray-700'}">Home</span>
                </div>
                <p class="text-xs text-gray-600 mt-1">
                  ${addr.flat}, ${addr.area}, ${addr.city} - ${addr.pincode}
                </p>
                <p class="text-xs text-gray-500"><i class="fas fa-phone-alt"></i> ${addr.mobile}</p>
                
                ${isSelected ? `
                  <div class="mt-2 text-green-600 font-semibold text-sm flex items-center">
                    <i class="fas fa-check-circle mr-1.5"></i>
                    Delivering Here
                  </div>
                ` : ''}
              </div>

              <div class="flex gap-1">
                <button type="button" class="edit-btn p-2 hover:bg-gray-100 rounded-lg" data-index="${i}">
                  <i class="fas fa-edit text-gray-600 text-sm"></i>
                </button>
                <button type="button" class="delete-btn p-2 hover:bg-red-50 rounded-lg" data-index="${i}">
                  <i class="fas fa-trash-alt text-red-500 text-sm"></i>
                </button>
              </div>
            </div>
          `;

          container.appendChild(card);
        });
      }

      updatePaymentSection() {
        const hasAddr = this.selectedIdx !== -1;
        const mobileBtn = document.getElementById('mobile-place-order-btn');
        const desktopBtn = document.getElementById('desktop-place-order-btn');
        const mobileWarn = document.getElementById('no-address-warning');
        const desktopWarn = document.getElementById('desktop-address-warning');
        const codInputs = document.querySelectorAll('input[value="cod"]');

        if (hasAddr) {
          mobileBtn.disabled = false; 
          mobileBtn.classList.remove('opacity-60', 'cursor-not-allowed');
          desktopBtn.disabled = false; 
          desktopBtn.classList.remove('opacity-60', 'cursor-not-allowed');
          mobileWarn.style.display = 'none'; 
          desktopWarn.style.display = 'none';
          // Enable COD option when address is selected
          codInputs.forEach(input => {
            input.disabled = false;
            input.closest('label').classList.remove('opacity-60', 'cursor-not-allowed');
          });
        } else {
          mobileBtn.disabled = true; 
          mobileBtn.classList.add('opacity-60', 'cursor-not-allowed');
          desktopBtn.disabled = true; 
          desktopBtn.classList.add('opacity-60', 'cursor-not-allowed');
          mobileWarn.style.display = 'block'; 
          desktopWarn.style.display = 'block';
          // Disable COD option when no address is selected
          codInputs.forEach(input => {
            input.disabled = true;
            input.closest('label').classList.add('opacity-60', 'cursor-not-allowed');
          });
        }
      }

      openModal(editIndex = -1) {
        document.getElementById('edit-index').value = editIndex;
        document.getElementById('modal-title').textContent = editIndex === -1 ? 'Add New Address' : 'Edit Address';
        const form = document.getElementById('address-form');
        if (editIndex === -1) form.reset();
        else {
          const addr = this.addresses[editIndex];
          if (addr) Object.keys(addr).forEach(k => { if (form[k]) form[k].value = addr[k]; });
        }
        document.getElementById('address-modal').classList.add('show');
      }

      closeModal() { document.getElementById('address-modal').classList.remove('show'); }

      setupEventListeners() {
        document.getElementById('add-address-btn').addEventListener('click', () => this.openModal(-1));
        document.getElementById('close-modal-btn').addEventListener('click', () => this.closeModal());
        document.getElementById('cancel-modal-btn').addEventListener('click', () => this.closeModal());
        document.getElementById('address-modal').addEventListener('click', e => { 
          if (e.target.id === 'address-modal') this.closeModal(); 
        });
        document.addEventListener('keydown', e => { 
          if (e.key === 'Escape') this.closeModal(); 
        });

        document.getElementById('address-form').addEventListener('submit', e => {
          e.preventDefault();
          const fd = new FormData(e.target);
          const addr = {
            fullName: fd.get('fullName').trim(),
            mobile: fd.get('mobile').trim(),
            flat: fd.get('flat').trim(),
            area: fd.get('area').trim(),
            city: fd.get('city').trim(),
            state: fd.get('state').trim(),
            pincode: fd.get('pincode').trim()
          };
          const editIdx = parseInt(document.getElementById('edit-index').value, 10);
          editIdx >= 0 ? this.updateAddress(editIdx, addr) : this.addAddress(addr);
          this.closeModal();
        });

        document.getElementById('mobile-place-order-btn').addEventListener('click', () => this.placeOrder());
        document.getElementById('desktop-place-order-btn').addEventListener('click', () => this.placeOrder());
        
        // Order success OK button
        document.getElementById('success-ok-btn').addEventListener('click', () => {
          // Clear cart and redirect to home
          localStorage.removeItem(STORAGE.CART);
          // Clear addresses too if you want
          // localStorage.removeItem(STORAGE.ADDRESSES);
          // localStorage.removeItem(STORAGE.SELECTED);
          
          // Redirect to home page
          window.location.href = '../home.html';
        });

        // Quantity and delete buttons event delegation
        document.getElementById('order-items').addEventListener('click', e => {
          // Quantity decrease button
          if (e.target.classList.contains('decrease') || e.target.closest('.decrease')) {
            const btn = e.target.classList.contains('decrease') ? e.target : e.target.closest('.decrease');
            const index = parseInt(btn.dataset.index, 10);
            const currentQty = this.cart[index].quantity || 1;
            if (currentQty > 1) {
              this.updateItemQuantity(index, currentQty - 1);
            }
          }
          
          // Quantity increase button
          if (e.target.classList.contains('increase') || e.target.closest('.increase')) {
            const btn = e.target.classList.contains('increase') ? e.target : e.target.closest('.increase');
            const index = parseInt(btn.dataset.index, 10);
            const currentQty = this.cart[index].quantity || 1;
            if (currentQty < 10) {
              this.updateItemQuantity(index, currentQty + 1);
            }
          }
          
          // Delete item button
          if (e.target.classList.contains('item-delete-btn') || e.target.closest('.item-delete-btn')) {
            const btn = e.target.classList.contains('item-delete-btn') ? e.target : e.target.closest('.item-delete-btn');
            const index = parseInt(btn.dataset.index, 10);
            this.deleteCartItem(index);
          }
        });

        // Quantity input direct editing
        document.getElementById('order-items').addEventListener('change', e => {
          if (e.target.classList.contains('qty-value')) {
            const index = parseInt(e.target.dataset.index, 10);
            const newQty = parseInt(e.target.value, 10) || 1;
            this.updateItemQuantity(index, newQty);
          }
        });

        // Quantity input validation
        document.getElementById('order-items').addEventListener('input', e => {
          if (e.target.classList.contains('qty-value')) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            const value = parseInt(e.target.value, 10);
            if (value > 10) e.target.value = '10';
            if (value < 1) e.target.value = '1';
          }
        });

        // Address container events
        document.getElementById('addresses-container').addEventListener('click', e => {
          const editBtn = e.target.closest('.edit-btn');
          const deleteBtn = e.target.closest('.delete-btn');
          const selectArea = e.target.closest('.select-address');
          if (editBtn) { 
            this.openModal(parseInt(editBtn.dataset.index, 10)); 
            return; 
          }
          if (deleteBtn) { 
            this.deleteAddress(parseInt(deleteBtn.dataset.index, 10)); 
            return; 
          }
          if (selectArea) { 
            this.selectAddress(parseInt(selectArea.dataset.index, 10)); 
          }
        });

        // Payment option selection styling
        document.querySelectorAll('input[name="payment_method"]').forEach(input => {
          input.addEventListener('change', (e) => {
            // Remove selected class from all labels
            document.querySelectorAll('.payment-option').forEach(label => {
              label.classList.remove('selected', 'border-[#70B2B2]', 'bg-[#f0f9f9]');
              label.classList.add('border-gray-300');
            });
            
            // Add selected class to the selected label
            if (e.target.checked) {
              const label = e.target.closest('.payment-option');
              if (label) {
                label.classList.add('selected', 'border-[#70B2B2]', 'bg-[#f0f9f9]');
                label.classList.remove('border-gray-300');
              }
            }
          });
        });

        // Initialize payment option styling
        const initialSelected = document.querySelector('input[name="payment_method"]:checked');
        if (initialSelected) {
          const label = initialSelected.closest('.payment-option');
          if (label) {
            label.classList.add('selected', 'border-[#70B2B2]', 'bg-[#f0f9f9]');
            label.classList.remove('border-gray-300');
          }
        }
      }

      // Inside the CheckoutApp class in checkout.html, add this method:

saveOrderToHistory(paymentMethod) {
    const orderId = Date.now(); // Unique order ID
    const now = new Date();
    const formattedDate = now.toISOString().split('T')[0]; // YYYY-MM-DD
    
    const order = {
        id: orderId,
        placedOn: formattedDate,
        status: 'placed',
        items: this.cart.map(item => ({
            name: item.name || 'Product',
            qty: item.quantity || 1,
            price: item.price || 0,
            img: item.image || 'https://via.placeholder.com/120?text=Product',
            weight: item.size || '1 unit'
        })),
        total: this.calculateTotal(),
        paymentMethod: paymentMethod,
        address: this.addresses[this.selectedIdx] || {},
        timestamp: now.getTime()
    };
    
    // Get existing orders
    let existingOrders = JSON.parse(localStorage.getItem('sweetOrders') || '[]');
    
    // Add new order
    existingOrders.push(order);
    
    // Save to localStorage
    localStorage.setItem('sweetOrders', JSON.stringify(existingOrders));
    
    return orderId;
}

calculateTotal() {
    let subtotal = 0;
    this.cart.forEach(item => {
        subtotal += (item.price || 0) * (item.quantity || 1);
    });
    const shipping = subtotal >= 799 ? 0 : 49;
    return subtotal + shipping;
}

        placeOrder() {
            if (this.selectedIdx === -1) return alert('Please select a delivery address!');
            
            const method = document.querySelector('input[name="payment_method"]:checked').value;
            const paymentMethodText = method === 'cod' ? 'Cash on Delivery' : 'UPI QR';
            const address = this.addresses[this.selectedIdx];
            
            // Save order using cart manager (this will also clear the cart)
            const orderId = cartManager.saveOrder(paymentMethodText, address);
            
            if (!orderId) {
                alert('Failed to place order. Cart might be empty.');
                return;
            }
            
            // Show success message with order ID
            this.showOrderSuccess(orderId, paymentMethodText);
            
            // Clear local cart reference
            this.cart = [];
        }

showOrderSuccess(orderId, paymentMethod) {
    // Launch confetti
    this.launchConfetti();
    
    // Update success modal with order details
    setTimeout(() => {
        const successModal = document.getElementById('order-success-modal');
        const title = successModal.querySelector('h2');
        const message = successModal.querySelector('p');
        
        title.textContent = `Yay! Order #${orderId} Placed Successfully!`;
        message.textContent = `Payment: ${paymentMethod}. Your order will be delivered soon.`;
        
        successModal.classList.add('show');
    }, 500);
}

      launchConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        
        // Check if confetti is available
        if (typeof confetti === 'undefined') {
          console.warn('Confetti library not loaded, using fallback animation');
          this.fallbackConfetti();
          return;
        }
        
        const myConfetti = confetti.create(canvas, {
          resize: true,
          useWorker: true
        });
        
        // Multiple confetti effects
        const end = Date.now() + 3000; // 3 seconds
        
        (function frame() {
          myConfetti({
            particleCount: 5,
            angle: 60,
            spread: 55,
            origin: { x: 0 },
            colors: ['#F875AA', '#70B2B2', '#1581BF', '#3B9797', '#FFD166']
          });
          
          myConfetti({
            particleCount: 5,
            angle: 120,
            spread: 55,
            origin: { x: 1 },
            colors: ['#F875AA', '#70B2B2', '#1581BF', '#3B9797', '#FFD166']
          });
          
          if (Date.now() < end) {
            requestAnimationFrame(frame);
          }
        }());
        
        // Center explosion
        setTimeout(() => {
          myConfetti({
            particleCount: 150,
            spread: 100,
            origin: { y: 0.6 }
          });
        }, 250);
        
        // More effects
        setTimeout(() => {
          myConfetti({
            particleCount: 100,
            angle: 90,
            spread: 70,
            origin: { x: 0.5, y: 0.8 }
          });
        }, 1000);
      }

      fallbackConfetti() {
        // Simple fallback animation if confetti library fails
        const modal = document.getElementById('order-success-modal');
        modal.style.animation = 'none';
        setTimeout(() => {
          modal.style.animation = 'pulse 0.5s 3';
        }, 10);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Don't add default items if cart already exists
      // Let it use whatever is in localStorage
      new CheckoutApp();
    });
  </script>


</body>
</html>